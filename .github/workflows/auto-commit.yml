name: Auto Commit and Push

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      commit_message:
        description: '提交信息'
        required: true
        default: 'chore: 自动提交更改'
      branch:
        description: '目标分支'
        required: true
        default: 'develop'
      files:
        description: '要提交的文件（用空格分隔，留空则提交所有更改）'
        required: false
        default: ''
  
  # 定时触发（可选，每天 UTC 0:00）
  schedule:
    - cron: '0 0 * * *'
  
  # 当特定文件变更时触发
  push:
    branches:
      - develop
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'tsconfig.json'
      - 'rollup.config.mjs'

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: 配置 Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: 检查是否有更改
        id: check-changes
        run: |
          git status
          if [ -n "${{ github.event.inputs.files }}" ]; then
            # 只检查指定的文件
            FILES="${{ github.event.inputs.files }}"
            CHANGED=$(git status --porcelain $FILES | wc -l)
          else
            # 检查所有更改
            CHANGED=$(git status --porcelain | wc -l)
          fi
          
          if [ "$CHANGED" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 添加文件到暂存区
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          if [ -n "${{ github.event.inputs.files }}" ]; then
            # 只添加指定的文件
            FILES="${{ github.event.inputs.files }}"
            git add $FILES
          else
            # 添加所有更改
            git add -A
          fi
          git status
      
      - name: 提交更改
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="chore: 自动提交更改 [skip ci]"
          fi
          git commit -m "$COMMIT_MSG" || exit 0
      
      - name: 推送到 GitHub
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="${GITHUB_REF#refs/heads/}"
          fi
          echo "推送到分支: $BRANCH"
          git push origin $BRANCH || exit 0
      
      - name: 输出结果
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ 代码已成功提交并推送到 GitHub"
          else
            echo "ℹ️  没有需要提交的更改"
          fi

