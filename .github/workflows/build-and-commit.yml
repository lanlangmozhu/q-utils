name: Build and Auto Commit

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'æäº¤ä¿¡æ¯'
        required: true
        default: 'chore: æ„å»ºå¹¶è‡ªåŠ¨æäº¤'
      branch:
        description: 'ç›®æ ‡åˆ†æ”¯'
        required: true
        default: 'develop'
      skip_build:
        description: 'è·³è¿‡æ„å»º'
        required: false
        type: boolean
        default: false
      skip_test:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        type: boolean
        default: false
  
  # å½“ä»£ç æ¨é€åˆ°ç‰¹å®šåˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - develop
    paths:
      - 'src/**'
      - 'package.json'
      - 'tsconfig.json'
      - 'rollup.config.mjs'

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
      
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile
      
      - name: è¿è¡Œæµ‹è¯•
        if: github.event.inputs.skip_test != 'true'
        run: pnpm test
      
      - name: ä»£ç æ£€æŸ¥
        if: github.event.inputs.skip_test != 'true'
        run: pnpm run lint || true
      
      - name: æ„å»ºé¡¹ç›®
        if: github.event.inputs.skip_build != 'true'
        run: pnpm run build
      
      - name: ç”Ÿæˆæ–‡æ¡£
        if: github.event.inputs.skip_build != 'true'
        run: pnpm run docs:generate || true
      
      - name: é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: æ£€æŸ¥æ›´æ”¹
        id: check-changes
        run: |
          git status
          CHANGED=$(git status --porcelain | wc -l)
          if [ "$CHANGED" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç° $CHANGED ä¸ªæ–‡ä»¶æœ‰æ›´æ”¹"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi
      
      - name: æ·»åŠ æ›´æ”¹
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git add -A
          git status
      
      - name: æäº¤æ›´æ”¹
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="chore: æ„å»ºå¹¶è‡ªåŠ¨æäº¤ [skip ci]"
          fi
          git commit -m "$COMMIT_MSG" || exit 0
      
      - name: æ¨é€åˆ° GitHub
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="${GITHUB_REF#refs/heads/}"
          fi
          echo "ğŸš€ æ¨é€åˆ°åˆ†æ”¯: $BRANCH"
          git push origin $BRANCH || exit 0
      
      - name: è¾“å‡ºç»“æœ
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… æ„å»ºå®Œæˆï¼Œä»£ç å·²æˆåŠŸæäº¤å¹¶æ¨é€åˆ° GitHub"
          else
            echo "â„¹ï¸  æ„å»ºå®Œæˆï¼Œæ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi

